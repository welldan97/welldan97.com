main = ->
  SELECTOR = '.plot-image-likes'

  D3OPTIONS = prepareD3(SELECTOR)
  getData (data) ->
    render(data, d3options)

prepareD3 = ->
  margin =
    top: 20
    right: 20
    bottom: 30
    left: 40

  width = 960 - margin.left - margin.right
  height = 500 - margin.top - margin.bottom
  x = d3.scale.linear().range([0, width])
  y = d3.scale.linear().range([height, 0])
  color = d3.scale.category10()
  xAxis = d3.svg.axis().scale(x).orient("bottom")
  yAxis = d3.svg.axis().scale(y).orient("left")

  svg = d3
    .select("body")
    .append("svg")
    .attr("width", width)
    .attr("height", height)

    # .attr("width", width + margin.left + margin.right)
    # .attr("height", height + margin.top + margin.bottom)
    .append("g")
    # .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

  svg: svg, x: x, y: y

getData = (cb) ->
  data = []
  d3.csv.parse csvSource, (row) ->
    row.likes = +row.likes
    row.createdTime = +row.createdTime
    row.loess = +row.loess
    row.score = +row.score
    data.push(row)
  cb(data)

render = (data, d3options) ->
  { svg: svg, x: x, y: y } = d3options
  x.domain(d3.extent(data, (d) -> d.createdTime)).nice()
  y.domain(d3.extent(data, (d) -> d.likes)).nice()
  svg
    .selectAll(".dot")
    .data(data)
    .enter()
    .append("circle")
    .attr("class", "dot")
    .attr("r", 2)
    .attr "cx", (d) ->
      x d.createdTime
    .attr "cy", (d) -> y d.likes


  line = d3.svg.line().x((d, i) ->
    x d.createdTime
  ).y((d) ->
    y d.loess
  )
  svg
    .append("path")
    .attr("d", line(_.reject(data, score: 0)))
    .attr('fill','transparent')
    .attr('stroke','black')

csvSource = """
likes,createdTime,loess,score
8,1403147273,10.3,2
8,1403069856,10.3,2
12,1402805688,10.2,4
4,1402728842,10.2,1
9,1402721743,10.2,3
8,1402644566,10.2,2
2,1402643448,0,0
7,1401935853,10.1,2
6,1401915135,10.1,2
13,1401740858,10,4
16,1401388184,10,5
9,1401387476,10,3
14,1400801157,9.9,5
11,1400340324,9.8,4
6,1400098601,9.8,2
8,1399834843,9.7,2
5,1399606714,9.7,1
10,1399587910,9.7,3
11,1399587800,9.7,4
16,1399524587,9.7,6
9,1399331205,9.6,3
9,1399331063,9.6,3
9,1399330845,9.6,3
13,1399257998,9.6,4
10,1399141139,9.6,3
11,1398809472,9.6,4
9,1398746825,9.6,3
14,1398636197,9.5,5
13,1398625086,9.5,5
1,1398453809,0,0
7,1398453648,9.5,2
14,1398404067,9.5,5
10,1398377402,9.5,3
5,1398364711,9.5,1
8,1398143555,9.5,3
12,1398058857,9.5,4
8,1398056610,9.5,3
10,1397706297,9.4,3
10,1397428586,9.4,3
10,1397375864,9.4,3
9,1397246765,9.3,3
9,1397188807,9.3,3
7,1397172515,9.3,2
12,1397166881,9.3,4
13,1397086641,9.3,5
16,1396998468,9.3,6
4,1396680035,9.3,1
11,1396592031,9.3,4
8,1396476253,9.2,3
15,1396461306,9.2,6
15,1396415014,9.2,6
13,1396237059,9.2,5
8,1396234745,9.2,3
7,1396169322,9.2,2
7,1396168872,9.2,2
7,1396030124,9.2,2
6,1395803271,9.2,2
6,1395776942,9.2,2
4,1395719172,9.2,1
5,1395640464,9.1,1
12,1395609394,9.1,4
11,1395591471,9.1,4
13,1395555825,9.1,5
11,1395552334,9.1,4
7,1395552272,9.1,2
15,1395551790,9.1,6
11,1395551694,9.1,4
9,1395551403,9.1,3
1,1395293644,0,0
7,1395117172,9.1,2
3,1392759837,8.8,1
10,1392759732,8.8,4
8,1389498724,8.6,3
8,1389498530,8.6,3
5,1389219579,8.6,2
3,1389072221,8.6,1
11,1387059409,8.6,4
8,1386627605,8.7,3
6,1386350902,8.7,2
8,1386123747,8.7,3
7,1385944955,8.8,2
15,1385655027,8.8,6
16,1384043366,9,6
6,1383714047,9.1,2
9,1383594263,9.1,3
16,1383512891,9.1,6
4,1383329073,9.1,1
8,1383166700,9.1,3
3,1382810172,9.2,1
6,1382734611,9.2,2
1,1382647251,0,0
9,1382233412,9.2,3
15,1382051891,9.3,6
6,1381702801,9.3,2
11,1381684654,9.3,4
7,1381607246,9.3,2
7,1381549519,9.3,2
6,1381345705,9.3,2
8,1381173899,9.4,3
13,1381102458,9.4,5
9,1380861669,9.4,3
11,1380847984,9.4,4
11,1380843609,9.4,4
11,1379619337,9.5,4
12,1379270920,9.5,4
8,1379195679,9.5,3
14,1379190408,9.5,5
7,1378925389,9.6,2
7,1378924615,9.6,2
0,1378923598,0,0
8,1378614398,9.6,2
9,1378581103,9.6,3
11,1378482745,9.6,4
10,1378095217,9.7,3
9,1377742093,9.7,3
14,1377303987,9.8,5
8,1376766778,9.8,2
9,1376452228,9.9,3
4,1376163345,9.9,1
8,1375993296,9.9,2
5,1375666460,9.9,1
5,1375300380,10,1
7,1374800822,10,2
10,1374187406,10,3
11,1374032925,10,4
12,1373847366,10,4
16,1373840035,10,5
14,1373430528,10,5
9,1373332656,10,3
17,1373165898,10,6
29,1373150435,10,10
7,1372542778,9.9,2
10,1371878134,9.9,3
15,1371239489,9.8,5
11,1370491394,9.7,4
14,1370234948,9.7,5
7,1369866207,9.6,2
6,1369702711,9.6,2
14,1369153737,9.5,5
11,1369101119,9.5,4
12,1368752044,9.5,4
8,1368064422,9.4,3
11,1367894553,9.4,4
17,1367771006,9.3,6
3,1367717150,9.3,1
9,1367716518,9.3,3
9,1366430943,9.1,3
5,1366331451,9.1,1
6,1366000988,9.1,2
6,1365783817,9,2
2,1365636599,0,0
9,1365451359,9,3
5,1364948399,8.9,1
3,1364669598,8.9,1
8,1364606771,8.9,3
3,1364507656,8.8,1
8,1364400693,8.8,3
5,1364266468,8.8,1
6,1363659536,8.7,2
9,1363291249,8.7,3
4,1361648171,8.4,1
7,1361555082,8.3,3
22,1358265535,7.6,10
16,1358223147,7.6,7
9,1358207305,7.6,4
8,1358206736,7.6,3
8,1358000423,7.6,3
7,1357998759,7.6,3
4,1357998547,7.6,1
10,1357998420,7.6,4
5,1357705708,7.5,2
8,1356797542,7.3,3
5,1355856681,7.1,2
1,1354680633,0,0
4,1354659548,6.8,2
4,1354646299,6.8,2
2,1354496902,0,0
1,1354496866,0,0
3,1354496771,6.8,1
3,1353175535,6.5,1
8,1351378880,6.1,4
3,1351359358,6.1,1
7,1351178757,6,4
6,1351099357,6,3
8,1350946180,6,4
3,1349828569,5.7,1
3,1349828447,5.7,1
6,1349724551,5.7,3
4,1349571538,5.6,2
2,1348777799,0,0
2,1348769122,0,0
3,1348194428,5.3,1
4,1348152546,5.3,2
8,1347749479,5.2,5
3,1347642420,5.2,2
4,1347334465,5.1,2
3,1347113501,5,2
5,1346934521,5,3
4,1346934456,5,2
4,1346478059,4.9,2
1,1346374361,0,0
1,1346287439,0,0
7,1346126996,4.8,5
0,1346041647,0,0
0,1346028333,0,0
6,1344806761,4.4,4
1,1344580051,0,0
7,1344310633,4.3,6
5,1344310088,4.3,4
2,1344043601,0,0
10,1343755824,4.1,9
4,1343434850,4.1,3
"""

main()
