SELECTOR = '.plot-image-likes'
RADIUS = 3

RATIO = 1/2

main = ->
  d3options = prepareD3(SELECTOR)
  getData (data) ->
    render(data, d3options)

prepareD3 = (selector)->
  width = $(selector).width()
  height = RATIO * width

  x = d3.scale.linear().range([0, width - RADIUS*2])
  y = d3.scale.linear().range([height - RADIUS*2, 0])

  svg = d3
    .select(selector)
    .append('svg')
    .attr('width', width)
    .attr('height', height)
    .append('g')

  svg: svg, x: x, y: y

getData = (cb) ->
  data = []
  d3.csv.parse CSV_SOURCE, (row) ->
    row.likes = +row.likes
    row.createdTime = +row.createdTime
    row.loess = +row.loess
    row.score = +row.score
    data.push(row)
  cb(data)

render = (data, d3options) ->
  { svg: svg, x: x, y: y } = d3options

  x.domain(d3.extent(data, (d) -> d.createdTime)).nice()
  y.domain(d3.extent(data, (d) -> d.likes)).nice()

  svg
    .selectAll '.image'
    .data data
    .enter()
    .append 'foreignObject'
    .attr 'width', '30'
    .attr 'height', '30'
    .attr 'class', (d) -> "image image-#{d.createdTime}"
    .attr 'x', (d) -> x d.createdTime
    .attr 'y', (d) -> y d.likes
    .attr 'x', (d) -> x d.createdTime
    .attr 'y', (d) -> y d.likes

  line = d3
    .svg
    .line()
    .interpolate('basis')
    .x (d) -> x d.createdTime
    .y (d) -> y d.loess

  loessData = _.reject data, (d, i)->
    return (d.score == 0) || (i % 3 > 0)

  svg
    .append 'path'
    .attr 'd', line(loessData)
    .attr 'class', 'one'

CSV_SOURCE = """
likes,createdTime,loess,score
8,1402434081,11.4,2
11,1402358300,11.4,3
17,1402112617,11.4,6
10,1401761962,11.3,3
5,1401761807,11.3,1
8,1401490848,11.2,2
10,1401490728,11.2,3
17,1401399080,11.2,6
19,1401398967,11.2,6
2,1401398727,0,0
21,1401310762,11.2,7
17,1401310491,11.2,6
19,1401234547,11.1,6
7,1401234261,11.1,2
4,1401234060,11.1,1
8,1401233766,11.1,2
7,1401220520,11.1,2
6,1401141350,11.1,2
3,1401141134,11.1,1
3,1401141024,11.1,1
5,1401139434,11.1,1
6,1401139038,11.1,2
21,1399324158,10.7,7
16,1399177045,10.7,6
4,1399176305,10.7,1
6,1399176071,10.7,2
14,1397988194,10.4,5
11,1397861638,10.4,4
14,1397861356,10.4,5
5,1397104483,10.2,1
14,1397084496,10.2,5
8,1396875088,10.2,3
15,1396584140,10.1,6
20,1396583731,10.1,8
5,1396583607,10.1,1
9,1396414734,10.1,3
17,1396231240,10,6
6,1396231092,10,2
14,1396137012,10,5
7,1396136621,10,2
14,1395967214,10,5
7,1395879934,9.9,2
13,1395832542,9.9,5
10,1395832477,9.9,4
17,1395783637,9.9,6
5,1395731831,9.9,2
7,1395699668,9.9,2
12,1395554278,9.9,4
21,1395553447,9.9,8
12,1395553018,9.9,4
6,1395552890,9.9,2
6,1395291333,9.8,2
10,1395046800,9.8,4
13,1395046639,9.8,5
10,1395046404,9.8,4
9,1395046041,9.8,3
10,1395045949,9.8,4
10,1394368435,9.6,4
10,1394368040,9.6,4
3,1394211867,9.6,1
4,1394131546,9.6,1
9,1392978438,9.3,3
8,1392978213,9.3,3
12,1392970893,9.3,5
9,1392093048,9.1,3
15,1391987638,9.1,6
5,1391384599,9,2
15,1391384481,9,6
8,1391384234,9,3
13,1391383794,9,5
8,1390597602,8.8,3
12,1390597164,8.8,5
11,1390521835,8.8,5
7,1390521776,8.8,3
8,1390149069,8.8,3
6,1390148904,8.8,2
5,1390148777,8.8,2
5,1390148772,8.8,2
16,1389571429,8.6,7
17,1389571196,8.6,7
12,1389571105,8.6,5
11,1389570933,8.6,5
16,1389570857,8.6,7
7,1389369700,8.6,3
10,1388928460,8.5,4
6,1388928356,8.5,2
6,1388928252,8.5,2
9,1388928181,8.5,4
5,1388928127,8.5,2
8,1388927824,8.5,3
10,1388921700,8.5,4
13,1388861601,8.5,6
11,1388861202,8.5,5
11,1388861115,8.5,5
6,1388860980,8.5,2
1,1388329381,0,0
12,1388079066,8.3,5
15,1388064304,8.3,7
8,1388063819,8.3,3
11,1388063533,8.3,5
7,1388058032,8.3,3
9,1387986800,8.3,4
11,1387669597,8.3,5
14,1387657457,8.3,6
4,1387402250,8.2,1
10,1387045734,8.1,4
6,1387026240,8.1,2
10,1387024645,8.1,4
6,1386881770,8.1,2
2,1386779472,0,0
8,1386764823,8.1,3
13,1386764753,8.1,6
4,1386544265,8,1
6,1386544151,8,2
4,1386544059,8,1
4,1386543981,8,1
4,1386543850,8,1
10,1386543798,8,5
10,1386384279,8,5
4,1386277938,8,1
9,1385908524,7.9,4
3,1385908458,7.9,1
5,1385908341,7.9,2
15,1385856290,7.9,7
7,1385856173,7.9,3
4,1385856129,7.9,2
3,1385835878,7.9,1
5,1385832437,7.9,2
6,1385334025,7.8,3
8,1385215135,7.8,4
5,1385214921,7.8,2
4,1385214717,7.8,2
6,1385214685,7.8,3
7,1385214461,7.8,3
6,1385214078,7.8,3
6,1385213982,7.8,3
3,1385207801,7.8,1
6,1385159609,7.8,3
1,1384987420,0,0
5,1384965129,7.8,2
2,1384965074,0,0
2,1384964994,0,0
3,1384964924,7.8,1
20,1384696624,7.7,10
5,1384625284,7.7,2
7,1384625056,7.7,3
7,1384624599,7.7,3
10,1384152891,7.6,5
5,1384074599,7.6,2
9,1384074271,7.6,4
5,1384074007,7.6,2
10,1384072793,7.6,5
8,1384072519,7.6,4
9,1382370335,7.3,4
5,1382183030,7.3,2
4,1382140041,7.3,2
0,1382139887,0,0
7,1381625129,7.2,3
11,1380525298,7.1,6
4,1379530047,7,2
2,1379529920,0,0
5,1379365809,7,2
5,1379365745,7,2
4,1379365662,7,2
3,1379365581,7,1
10,1379365405,7,5
8,1379067902,6.9,4
8,1378745642,6.9,4
5,1378063245,6.8,2
4,1377458311,6.8,2
5,1377454217,6.8,2
2,1377454146,0,0
7,1377454092,6.8,4
9,1377453863,6.8,5
5,1377453745,6.8,2
17,1375619012,6.6,10
12,1375618954,6.6,7
2,1375118738,0,0
13,1375012445,6.5,8
1,1374568721,0,0
6,1374568681,6.5,3
5,1374568617,6.5,3
2,1374568438,0,0
8,1374568195,6.5,4
4,1374568065,6.5,2
6,1374503563,6.5,3
7,1374503508,6.5,4
7,1374503425,6.5,4
5,1374503346,6.5,3
5,1374503219,6.5,3
6,1374503079,6.5,3
5,1374441139,6.5,3
8,1373933568,6.4,5
3,1373809414,6.4,1
6,1373809361,6.4,3
3,1373721323,6.4,1
1,1373707238,0,0
1,1373707145,0,0
5,1373623495,6.4,3
3,1373582629,6.4,1
4,1373309194,6.3,2
1,1373071036,0,0
9,1372934406,6.3,5
5,1372811904,6.3,3
4,1372811741,6.3,2
3,1372685086,6.3,1
4,1372334373,6.3,2
6,1372227397,6.2,3
6,1372178537,6.2,3
7,1371902709,6.2,4
5,1371902694,6.2,3
6,1371806249,6.2,3
3,1371741319,6.2,1
6,1371406643,6.2,3
2,1371293096,0,0
7,1371036313,6.1,4
10,1371036239,6.1,6
6,1371036113,6.1,3
11,1371036038,6.1,7
6,1370883850,6.1,3
9,1370883776,6.1,5
6,1370883606,6.1,3
5,1370883475,6.1,3
7,1370883346,6.1,4
4,1370883280,6.1,2
5,1370882952,6.1,3
3,1370806005,6.1,1
7,1370805925,6.1,4
3,1370805737,6.1,1
2,1370723401,0,0
2,1370723229,0,0
4,1370613910,6.1,2
7,1370539890,6.1,4
9,1370514653,6.1,6
7,1370497467,6.1,4
1,1370496684,0,0
7,1370335383,6.1,4
5,1370239256,6,3
9,1370157147,6,6
5,1370157027,6,3
3,1370156576,6,1
5,1369999703,6,3
5,1369898719,6,3
6,1369898658,6,4
7,1369898533,6,4
6,1369898445,6,4
3,1369628466,6,1
7,1369628216,6,4
7,1369628103,6,4
8,1369561013,6,5
4,1369560919,6,2
10,1369560802,6,6
3,1369560794,6,1
6,1369560217,6,4
8,1369463993,6,5
7,1369463775,6,4
12,1369463770,6,8
4,1369463074,6,2
4,1369463015,6,2
6,1369370628,5.9,4
16,1369370364,5.9,10
5,1369370071,5.9,3
2,1369369923,0,0
5,1369369859,5.9,3
8,1369270700,5.9,5
9,1369270596,5.9,6
8,1369270316,5.9,5
3,1369270267,5.9,2
5,1369270010,5.9,3
7,1369177937,5.9,4
5,1369177885,5.9,3
6,1369177843,5.9,4
7,1369177798,5.9,4
5,1369177790,5.9,3
7,1369117986,5.9,4
7,1369117825,5.9,4
9,1369117476,5.9,6
5,1369117409,5.9,3
3,1369117314,5.9,2
6,1369043047,5.9,4
7,1369035069,5.9,4
10,1369035015,5.9,6
8,1369034924,5.9,5
9,1369034843,5.9,6
5,1369034797,5.9,3
5,1368932811,5.9,3
8,1368932734,5.9,5
4,1368932660,5.9,2
3,1368932554,5.9,2
8,1368932479,5.9,5
2,1368870145,0,0
8,1368870036,5.9,5
4,1368869874,5.9,2
7,1368869708,5.9,4
8,1368816806,5.9,5
4,1368816720,5.9,2
6,1368816637,5.9,4
4,1368816609,5.9,2
6,1368816536,5.9,4
5,1368710655,5.9,3
5,1368710567,5.9,3
3,1368710243,5.9,2
6,1368710236,5.9,4
5,1368710226,5.9,3
4,1366382731,5.6,2
3,1366381969,5.6,2
5,1366381862,5.6,3
6,1366381823,5.6,4
3,1366381785,5.6,2
8,1366381773,5.6,5
10,1365826116,5.5,7
2,1365825655,0,0
9,1365586573,5.5,6
4,1365174243,5.4,2
6,1365174188,5.4,4
5,1365174093,5.4,3
4,1365174065,5.4,2
5,1365174000,5.4,3
5,1365173974,5.4,3
5,1365089131,5.4,3
6,1364983381,5.4,4
7,1364971348,5.4,5
4,1364971217,5.4,2
6,1364745159,5.3,4
5,1364651393,5.3,3
2,1364651328,0,0
3,1364651251,5.3,2
6,1364651172,5.3,4
6,1364613573,5.3,4
1,1364613524,0,0
7,1364613478,5.3,5
8,1364613447,5.3,6
1,1364613446,0,0
1,1364613345,0,0
2,1364554913,0,0
3,1364554727,5.3,2
5,1364554697,5.3,3
5,1364554460,5.3,3
6,1364311990,5.3,4
6,1364311974,5.3,4
5,1364311897,5.3,3
5,1364208572,5.3,3
7,1364208437,5.3,5
6,1364208387,5.3,4
2,1364208361,0,0
4,1364208265,5.3,3
6,1364208203,5.3,4
5,1364208111,5.3,3
4,1364208035,5.3,3
6,1364207811,5.3,4
7,1364207787,5.3,5
3,1364092180,5.3,2
3,1364092130,5.3,2
4,1364092028,5.3,3
3,1364091886,5.3,2
3,1363527311,5.2,2
3,1363398417,5.2,2
3,1363131234,5.2,2
6,1363131165,5.2,4
2,1363131072,0,0
7,1363131044,5.2,5
2,1363130916,0,0
5,1363130893,5.2,3
4,1363130854,5.2,3
6,1362749041,5.1,4
2,1362748835,0,0
4,1362707583,5.1,3
5,1362576723,5.1,3
3,1362523618,5.1,2
3,1362523562,5.1,2
3,1362523525,5.1,2
6,1362523475,5.1,4
9,1362394494,5.1,7
3,1362394416,5.1,2
6,1362288437,5.1,4
7,1362024647,5,5
5,1362024476,5,3
6,1362024312,5,4
5,1361746115,5,4
4,1361658990,5,3
3,1361658956,5,2
3,1361658886,5,2
6,1361423208,5,4
12,1361423171,5,9
6,1361422894,5,4
2,1361422618,0,0
3,1361422530,5,2
2,1361329627,0,0
3,1361329448,5,2
3,1361329057,5,2
1,1361328854,0,0
5,1361328790,5,4
3,1361250074,5,2
1,1361249964,0,0
3,1361249960,5,2
2,1361249773,0,0
4,1361249734,5,3
7,1361115910,5,5
2,1361115728,0,0
3,1360880890,4.9,2
4,1360761316,4.9,3
3,1360761292,4.9,2
6,1360123957,4.9,4
2,1360069577,0,0
3,1360068274,4.9,2
4,1360067774,4.9,3
6,1360067260,4.9,4
5,1359980366,4.9,4
8,1359962840,4.9,6
3,1359710933,4.8,2
5,1359710857,4.8,4
2,1359710616,0,0
2,1359686554,0,0
4,1359685492,4.8,3
2,1359685411,0,0
6,1359685372,4.8,5
1,1359685251,0,0
1,1359685210,0,0
3,1358791544,4.8,2
6,1358668162,4.7,5
5,1358599796,4.7,4
5,1358599548,4.7,4
2,1358599360,0,0
3,1358599153,4.7,2
4,1358598894,4.7,3
3,1358595587,4.7,2
8,1358340123,4.7,6
6,1358340048,4.7,5
5,1358339997,4.7,4
6,1358339933,4.7,5
2,1358339856,0,0
6,1358339125,4.7,5
6,1358339079,4.7,5
3,1358339017,4.7,2
4,1358338956,4.7,3
2,1358338940,0,0
8,1358338879,4.7,6
5,1358230162,4.7,4
4,1358230009,4.7,3
3,1358229914,4.7,2
6,1358229844,4.7,5
3,1358169359,4.7,2
2,1358063299,0,0
2,1358062873,0,0
4,1357890590,4.7,3
4,1357832120,4.7,3
3,1357815138,4.7,2
2,1357728581,0,0
2,1357714096,0,0
7,1357714010,4.7,6
5,1357713937,4.7,4
2,1357713854,0,0
4,1357650732,4.7,3
4,1357551361,4.6,3
1,1357551217,0,0
5,1357551074,4.6,4
1,1357551032,0,0
4,1357551004,4.6,3
4,1357550902,4.6,3
6,1357550834,4.6,5
4,1357550698,4.6,3
3,1357534607,4.6,2
1,1357480661,0,0
2,1357480567,0,0
3,1357476857,4.6,2
5,1357475473,4.6,4
3,1357475445,4.6,2
4,1357475405,4.6,3
4,1357388162,4.6,3
3,1357315755,4.6,2
5,1357071689,4.6,4
4,1357071656,4.6,3
4,1357071518,4.6,3
5,1356848613,4.6,4
4,1356848570,4.6,3
4,1356848567,4.6,3
10,1356435782,4.6,8
4,1356287464,4.5,3
4,1356016561,4.5,3
6,1355994411,4.5,5
1,1355909155,0,0
4,1355909057,4.5,3
6,1355814630,4.5,5
4,1355735281,4.5,3
2,1355489399,0,0
5,1355483820,4.5,4
4,1355483765,4.5,3
4,1355483717,4.5,3
4,1355483677,4.5,3
2,1355405585,0,0
2,1355405577,0,0
5,1354787857,4.4,4
5,1354715156,4.4,4
4,1354691250,4.4,3
2,1354343150,0,0
5,1354343142,4.4,4
3,1354343137,4.4,2
5,1354343129,4.4,4
3,1353762358,4.3,2
3,1353762110,4.3,2
2,1353762084,0,0
3,1353762018,4.3,2
2,1353761997,0,0
5,1353737801,4.3,4
4,1353737430,4.3,3
6,1353497872,4.3,5
5,1353497017,4.3,4
3,1353496865,4.3,2
6,1353384165,4.3,5
5,1353379748,4.3,4
1,1353379679,0,0
1,1353368148,0,0
2,1353368099,0,0
5,1353368001,4.3,4
6,1353299492,4.3,5
3,1353299302,4.3,2
4,1353299118,4.3,3
2,1353238438,0,0
5,1353238388,4.3,4
4,1353238276,4.3,3
3,1353169003,4.3,2
3,1353063594,4.3,2
7,1352915291,4.3,6
4,1352914811,4.3,3
2,1352914723,0,0
4,1352914682,4.3,3
3,1352879865,4.3,2
3,1352879812,4.3,2
6,1352817193,4.3,5
5,1352817182,4.3,4
7,1352623374,4.3,6
3,1352567098,4.3,2
3,1352552950,4.3,2
4,1352543464,4.3,3
4,1352543387,4.3,3
3,1352193282,4.2,2
4,1352193279,4.2,3
2,1352138656,0,0
6,1351920659,4.2,5
5,1351920495,4.2,4
2,1351920318,0,0
3,1351920138,4.2,2
3,1351758710,4.2,2
2,1351716970,0,0
3,1351716871,4.2,2
4,1351606270,4.2,3
3,1351581732,4.2,2
1,1351581638,0,0
5,1351581590,4.2,4
7,1351581559,4.2,6
6,1351516875,4.2,5
5,1351516747,4.2,4
7,1351406287,4.2,6
3,1351252820,4.2,2
4,1351250194,4.2,3
5,1351153732,4.2,4
1,1351153641,0,0
3,1351153496,4.2,2
3,1351153449,4.2,2
3,1351153292,4.2,2
7,1351153123,4.2,6
4,1351014399,4.2,3
4,1350981584,4.2,3
2,1350902213,0,0
4,1350838350,4.1,3
4,1350834203,4.1,3
4,1350812656,4.1,3
5,1350812491,4.1,4
4,1350812395,4.1,3
3,1350812318,4.1,2
4,1350812231,4.1,3
4,1350529895,4.1,3
5,1350455787,4.1,4
1,1350404535,0,0
6,1350403502,4.1,5
2,1350382205,0,0
1,1350372402,0,0
4,1350284564,4.1,3
8,1350241865,4.1,7
3,1350241760,4.1,2
7,1350241738,4.1,6
1,1349934697,0,0
7,1349802758,4.1,6
2,1349802614,0,0
2,1349802534,0,0
5,1349802299,4.1,4
2,1349801980,0,0
5,1349603766,4.1,4
1,1349603568,0,0
3,1349538784,4.1,2
3,1349081906,4,2
4,1348919240,4,4
4,1348910353,4,4
1,1348908487,0,0
1,1348859054,0,0
3,1348266025,4,3
3,1348234806,4,3
3,1348151997,4,3
2,1347186314,0,0
1,1347186087,0,0
3,1346753600,3.9,3
3,1345833798,3.8,3
2,1345833684,0,0
2,1345134925,0,0
4,1344273942,3.8,4
1,1344273748,0,0
3,1343831651,3.7,3
2,1342849662,0,0
0,1342849435,0,0
3,1342849225,3.7,3
1,1342848995,0,0
1,1342848819,0,0
0,1342848701,0,0
2,1342848628,0,0
4,1342541838,3.7,4
0,1342541689,0,0
4,1342479741,3.7,4
0,1342479540,0,0
0,1342479386,0,0
4,1342479223,3.7,4
2,1342479150,0,0
0,1342478886,0,0
0,1342478632,0,0
2,1342478410,0,0
1,1342478162,0,0
2,1342478040,0,0
3,1342477908,3.7,3
2,1342477772,0,0
3,1342477420,3.7,3
1,1342079435,0,0
2,1342079279,0,0
2,1341236321,0,0
1,1341157352,0,0
1,1341157213,0,0
1,1340918162,0,0
1,1340917717,0,0
2,1340565700,0,0
1,1340537079,0,0
2,1340493433,0,0
0,1340493425,0,0
2,1340085068,0,0
1,1339868708,0,0
0,1339796707,0,0
0,1339710418,0,0
0,1339710411,0,0
2,1339479950,0,0
1,1339452418,0,0
0,1339333143,0,0
1,1339332943,0,0
0,1339332503,0,0
0,1339332092,0,0
1,1339331955,0,0
2,1339320347,0,0
2,1339225729,0,0
0,1339210886,0,0
3,1338915276,3.6,3
0,1338638264,0,0
1,1338637662,0,0
1,1338630030,0,0
0,1338545432,0,0
0,1338035266,0,0
0,1338032031,0,0
0,1338030324,0,0
0,1338023859,0,0
1,1338023420,0,0
1,1338020949,0,0
0,1338019866,0,0
0,1338018295,0,0
0,1338016382,0,0
1,1338016258,0,0
0,1338016073,0,0
0,1338013505,0,0
0,1338012228,0,0
0,1338011975,0,0
0,1338011902,0,0
0,1338010490,0,0
0,1338010300,0,0
0,1337975971,0,0
0,1337969928,0,0
0,1337966752,0,0
1,1337961687,0,0
0,1337961253,0,0
1,1337960592,0,0
0,1337960088,0,0
0,1337959818,0,0
0,1337959734,0,0
0,1337959681,0,0
0,1337952713,0,0
0,1337952576,0,0
0,1337937027,0,0
1,1337927022,0,0
0,1337925448,0,0
0,1337923174,0,0
0,1337923064,0,0
0,1337922247,0,0
1,1337922095,0,0
1,1337921222,0,0
0,1337917471,0,0
1,1337706930,0,0
2,1337663998,0,0
1,1337428980,0,0
"""

main()
